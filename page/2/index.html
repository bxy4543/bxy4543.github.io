<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/page/2/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 6.1.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-zh/reference/cli" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/02/15/zh/reference/cli/" class="article-date">
  <time class="dt-published" datetime="2022-02-15T02:17:58.625Z" itemprop="datePublished">2022-02-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Command-line-reference"><a href="#Command-line-reference" class="headerlink" title="Command line reference"></a>Command line reference</h1><p>Checkout the <a target="_blank" rel="noopener" href="https://github.com/alibaba/sealer/blob/main/docs/commandline/sealer.md">auto generate commandline reference</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/02/15/zh/reference/cli/" data-id="cl1fryzye000l26e2gb1b249n" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-zh/index" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/02/15/zh/index/" class="article-date">
  <time class="dt-published" datetime="2022-02-15T02:17:58.624Z" itemprop="datePublished">2022-02-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="构建-amp-运行一个自定义kuberentes集群"><a href="#构建-amp-运行一个自定义kuberentes集群" class="headerlink" title="构建&amp;运行一个自定义kuberentes集群"></a>构建&amp;运行一个自定义kuberentes集群</h1><p>本例中介绍如何构建一个包含dashboard的集群镜像，然后一键启动。</p>
<p><a target="_blank" rel="noopener" href="https://asciinema.org/a/446106?speed=3"><img src="https://asciinema.org/a/446106.svg" alt="asciicast"></a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/02/15/zh/index/" data-id="cl1fryzxx000226e28fj8edgt" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-zh/help/contact" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/02/15/zh/help/contact/" class="article-date">
  <time class="dt-published" datetime="2022-02-15T02:17:58.624Z" itemprop="datePublished">2022-02-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Contacts"><a href="#Contacts" class="headerlink" title="Contacts"></a>Contacts</h1><ul>
<li>Email: <a href="mailto:&#x73;&#x65;&#x61;&#x6c;&#101;&#114;&#x40;&#x6c;&#x69;&#115;&#116;&#x2e;&#97;&#108;&#105;&#x62;&#97;&#x62;&#97;&#x2d;&#x69;&#110;&#x63;&#46;&#x63;&#x6f;&#x6d;">&#x73;&#x65;&#x61;&#x6c;&#101;&#114;&#x40;&#x6c;&#x69;&#115;&#116;&#x2e;&#97;&#108;&#105;&#x62;&#97;&#x62;&#97;&#x2d;&#x69;&#110;&#x63;&#46;&#x63;&#x6f;&#x6d;</a></li>
<li>DingTalk Group: 34619594</li>
<li>Wechat: fangnux</li>
</ul>
<p>If you’re using sealer, <a target="_blank" rel="noopener" href="https://github.com/alibaba/sealer/issues/119">let us know</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/02/15/zh/help/contact/" data-id="cl1fryzy9000e26e29tehel0r" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-zh/help/faq" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/02/15/zh/help/faq/" class="article-date">
  <time class="dt-published" datetime="2022-02-15T02:17:58.624Z" itemprop="datePublished">2022-02-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h1><p>This section is mean to answer the most frequently asked questions about sealer. And it will be updated regularly.</p>
<h2 id="How-to-clean-host-environment-manually-when-sealer-apply-failed"><a href="#How-to-clean-host-environment-manually-when-sealer-apply-failed" class="headerlink" title="How to clean host environment manually when sealer apply failed."></a>How to clean host environment manually when sealer apply failed.</h2><p>in some case ,when you failed to run sealer apply ,and the hints show a little that is not enough to use, this section<br>will guild you how to clean your host manually.</p>
<p>you may follow the below clean steps when run kubeadm init failed.</p>
<h3 id="umount-rootfs-or-apply-mount-if-it-existed"><a href="#umount-rootfs-or-apply-mount-if-it-existed" class="headerlink" title="umount rootfs or apply mount if it existed"></a>umount rootfs or apply mount if it existed</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">df -h | grep sealer</span><br><span class="line">overlay          40G  7.3G   31G  20% /var/lib/sealer/data/my-cluster/rootfs</span><br></pre></td></tr></table></figure>

<p>umount examples:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">umount /var/lib/sealer/data/my-cluster/rootfs</span><br></pre></td></tr></table></figure>

<h2 id="delete-rootfs-directory-if-it-existed"><a href="#delete-rootfs-directory-if-it-existed" class="headerlink" title="delete rootfs directory if it existed"></a>delete rootfs directory if it existed</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rm -rf /var/lib/sealer/data/my-cluster</span><br></pre></td></tr></table></figure>

<h2 id="delete-kubernetes-directory-if-it-existed"><a href="#delete-kubernetes-directory-if-it-existed" class="headerlink" title="delete kubernetes directory if it existed"></a>delete kubernetes directory if it existed</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rm -rf /etc/kubernetes</span><br><span class="line">rm -rf /etc/cni</span><br><span class="line">rm -rf /opt/cni</span><br></pre></td></tr></table></figure>

<h2 id="delete-docker-registry-if-it-existed"><a href="#delete-docker-registry-if-it-existed" class="headerlink" title="delete docker registry if it existed"></a>delete docker registry if it existed</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker ps</span><br><span class="line">docker rm -f -v sealer-registry</span><br></pre></td></tr></table></figure>

<p>you may follow the below clean steps if your cluster is up.</p>
<h2 id="kubeadm-reset"><a href="#kubeadm-reset" class="headerlink" title="kubeadm reset"></a>kubeadm reset</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm reset -f</span><br></pre></td></tr></table></figure>

<h2 id="delete-kube-config-and-kubelet-if-it-existed"><a href="#delete-kube-config-and-kubelet-if-it-existed" class="headerlink" title="delete kube config and kubelet if it existed"></a>delete kube config and kubelet if it existed</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">rm -rf $HOME/.kube/config</span><br><span class="line">rm -rf ~/.kube/ &amp;&amp; rm -rf /etc/kubernetes/ &amp;&amp; \</span><br><span class="line">rm -rf /etc/systemd/system/kubelet.service.d &amp;&amp; rm -rf /etc/systemd/system/kubelet.service &amp;&amp; \</span><br><span class="line">rm -rf /usr/bin/kube* &amp;&amp; rm -rf /usr/bin/crictl &amp;&amp; \</span><br><span class="line">rm -rf /etc/cni &amp;&amp; rm -rf /opt/cni &amp;&amp; \</span><br><span class="line">rm -rf /var/lib/etcd &amp;&amp; rm -rf /var/etcd</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/02/15/zh/help/faq/" data-id="cl1fryzy9000f26e2hfb3b18u" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-zh/getting-started/run-cluster" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/02/15/zh/getting-started/run-cluster/" class="article-date">
  <time class="dt-published" datetime="2022-02-15T02:17:58.623Z" itemprop="datePublished">2022-02-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Run-a-cluster"><a href="#Run-a-cluster" class="headerlink" title="Run a cluster"></a>Run a cluster</h1><h2 id="Run-on-exist-servers"><a href="#Run-on-exist-servers" class="headerlink" title="Run on exist servers"></a>Run on exist servers</h2><table>
<thead>
<tr>
<th>Server ip address</th>
<th>192.168.0.1 ~ 192.168.0.13</th>
</tr>
</thead>
<tbody><tr>
<td><strong>server password</strong></td>
<td><strong>sealer123</strong></td>
</tr>
</tbody></table>
<p><em>Run the kubernetes cluster on the local server.</em></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sealer run kubernetes:v1.19.8 \</span><br><span class="line">   -m 192.168.0.1,192.168.0.2,192.168.0.3 \</span><br><span class="line">   -n 192.168.0.4,192.168.0.5,192.168.0.6 \</span><br><span class="line">   -p sealer123 # ssh passwd</span><br></pre></td></tr></table></figure>

<p><em>Check the Cluster</em></p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@iZm5e42unzb79kod55hehvZ ~]# kubectl get node</span><br><span class="line">NAME                    STATUS ROLES AGE VERSION</span><br><span class="line">izm5e42unzb79kod55hehvz Ready master 18h v1.19.8</span><br><span class="line">izm5ehdjw3kru84f0kq7r7z Ready master 18h v1.19.8</span><br><span class="line">izm5ehdjw3kru84f0kq7r8z Ready master 18h v1.19.8</span><br><span class="line">izm5ehdjw3kru84f0kq7r9z Ready &lt;none&gt; 18h v1.19.8</span><br><span class="line">izm5ehdjw3kru84f0kq7raz Ready &lt;none&gt; 18h v1.19.8</span><br><span class="line">izm5ehdjw3kru84f0kq7rbz Ready &lt;none&gt; 18h v1.19.8</span><br></pre></td></tr></table></figure>

<h3 id="scale-up-and-down"><a href="#scale-up-and-down" class="headerlink" title="scale up and down"></a>scale up and down</h3><p><em>Using join command to scale up the local server.</em></p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sealer <span class="built_in">join</span> \</span></span><br><span class="line"><span class="language-bash">   --masters 192.168.0.7,192.168.0.8,192.168.0.9,192.168.0.10 \</span></span><br><span class="line"><span class="language-bash">   --nodes 192.168.0.11,192.168.0.12,192.168.0.13</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">or</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sealer <span class="built_in">join</span> --masters 192.168.0.7-192.168.0.10 --nodes 192.168.0.11-192.168.0.13</span></span><br></pre></td></tr></table></figure>

<p><em>Using delete command to scale down the local server.</em></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sealer delete \</span></span><br><span class="line"><span class="language-bash">   --masters 192.168.0.7,192.168.0.8,192.168.0.9,192.168.0.10 \</span></span><br><span class="line"><span class="language-bash">   --nodes 192.168.0.11,192.168.0.12,192.168.0.13</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">or</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sealer delete --masters 192.168.0.7-192.168.0.10 --nodes 192.168.0.11-192.168.0.13</span></span><br></pre></td></tr></table></figure>

<h2 id="Clean-up-the-Kubernetes-cluster"><a href="#Clean-up-the-Kubernetes-cluster" class="headerlink" title="Clean up the Kubernetes cluster"></a>Clean up the Kubernetes cluster</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sealer delete --all</span><br></pre></td></tr></table></figure>

<p>Sealer will also remove infrastructure resources if you use cloud mod.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/02/15/zh/getting-started/run-cluster/" data-id="cl1fryzyd000k26e21rkpa6wh" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-zh/getting-started/build-appimage" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/02/15/zh/getting-started/build-appimage/" class="article-date">
  <time class="dt-published" datetime="2022-02-15T02:17:58.621Z" itemprop="datePublished">2022-02-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Build-application-image"><a href="#Build-application-image" class="headerlink" title="Build application image"></a>Build application image</h1><h2 id="Motivations"><a href="#Motivations" class="headerlink" title="Motivations"></a>Motivations</h2><p>Applications image contains applications with all dependencies except the base image, so applications image can install<br>to an already existing Kubernetes cluster. with applications image, cluster can be incremental updating, and we can<br>install applications to an already existing Kubernetes cluster.</p>
<h2 id="Use-cases"><a href="#Use-cases" class="headerlink" title="Use cases"></a>Use cases</h2><h3 id="Build-an-application-image"><a href="#Build-an-application-image" class="headerlink" title="Build an application image"></a>Build an application image</h3><p>just add argument “–base&#x3D;false”, will build an application image. and the size of application image depends on the<br>docker image size in most cases. without rootfs,it will become slimmer.</p>
<p>For example to build a prometheus application image:<br>Kubefile:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">FROM registry.cn-qingdao.aliyuncs.com/sealer-apps/openebs-localpv:2.11.0</span><br><span class="line">COPY prometheus manifests</span><br><span class="line">CMD kubectl apply -f prometheus/crd.yaml</span><br><span class="line">CMD kubectl apply -f prometheus/operator.yaml</span><br></pre></td></tr></table></figure>

<p>build command:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sealer build -f Kubefile -t prometheus:2.30.0 --base=false .</span><br></pre></td></tr></table></figure>

<p>The image prometheus:2.30.0 will not contain the embedded Kubernetes cluster. and it only contains all the docker image<br>that application needs, and contains helm chart or other operator manifests.</p>
<h3 id="Apply-this-application-image"><a href="#Apply-this-application-image" class="headerlink" title="Apply this application image"></a>Apply this application image</h3><p>We can only support sealer cluster currently. Sealer hacked docker and registry to cache docker image in cluster, so if<br>cluster not installed by sealer, this app image will install failed.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sealer run prometheus:2.30.0</span><br></pre></td></tr></table></figure>

<p>Or using Clusterfile to overwrite the config files like helm values.</p>
<h3 id="Merge-two-application-images"><a href="#Merge-two-application-images" class="headerlink" title="Merge two application images"></a>Merge two application images</h3><p>Using sealer merge ,we can combine the app image as one,in the meantime we can merge application images with cloud<br>images.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sealer merge mysql:8.0.26 redis:6.2.5 -t mysql-redis:latest</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/02/15/zh/getting-started/build-appimage/" data-id="cl1fryzya000g26e2f6d7hrkn" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-zh/contributing/contribute" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/02/15/zh/contributing/contribute/" class="article-date">
  <time class="dt-published" datetime="2022-02-15T02:17:58.620Z" itemprop="datePublished">2022-02-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Contributing"><a href="#Contributing" class="headerlink" title="Contributing"></a>Contributing</h1><p>👉 Make sure to read the <a target="_blank" rel="noopener" href="https://github.com/alibaba/sealer/blob/main/code-of-conduct.md">Code of Conduct</a>.</p>
<h2 id="Contribute-to-Docs"><a href="#Contribute-to-Docs" class="headerlink" title="Contribute to Docs"></a>Contribute to Docs</h2><p>👉 Follow the <a target="_blank" rel="noopener" href="https://github.com/alibaba/sealer/issues/628">guide</a>.</p>
<h2 id="Contributing-guide"><a href="#Contributing-guide" class="headerlink" title="Contributing guide"></a>Contributing guide</h2><p>👉 Follow the <a target="_blank" rel="noopener" href="https://github.com/alibaba/sealer/blob/main/CONTRIBUTING.md">guide</a>.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/02/15/zh/contributing/contribute/" data-id="cl1fryzxy000326e25f8xcx9n" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-zh/contributing/code-of-conduct" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/02/15/zh/contributing/code-of-conduct/" class="article-date">
  <time class="dt-published" datetime="2022-02-15T02:17:58.620Z" itemprop="datePublished">2022-02-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Code-of-conduct"><a href="#Code-of-conduct" class="headerlink" title="Code of conduct"></a>Code of conduct</h1><p><a target="_blank" rel="noopener" href="https://github.com/alibaba/sealer/blob/main/code-of-conduct.md">code of conduct</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/02/15/zh/contributing/code-of-conduct/" data-id="cl1fryzy1000626e2f0l68qum" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-zh/advanced/raw-docker-baseimage" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/02/15/zh/advanced/raw-docker-baseimage/" class="article-date">
  <time class="dt-published" datetime="2022-02-15T02:17:58.619Z" itemprop="datePublished">2022-02-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Raw-docker-BaseImage"><a href="#Raw-docker-BaseImage" class="headerlink" title="Raw docker BaseImage"></a>Raw docker BaseImage</h1><h2 id="Motivations"><a href="#Motivations" class="headerlink" title="Motivations"></a>Motivations</h2><p>The existing base images mostly use customized docker, but many k8s clusters use raw docker as container runtime. So it’s necessary to provide a base image with raw docker, this page is a guide of how to get a base image with raw docker.</p>
<h2 id="Use-cases"><a href="#Use-cases" class="headerlink" title="Use cases"></a>Use cases</h2><h3 id="How-to-use-it"><a href="#How-to-use-it" class="headerlink" title="How to use it"></a>How to use it</h3><p>We provide an official BaseImage which uses official raw docker as container runtime: <code>kubernetes-rawdocker:v1.19.8</code>. If you want to create a k8s cluster, you can use it directly as <code>sealer run</code> command’s argument or write it into your Clusterfile. If you want to use it as the base image to build other images by <code>sealer build</code>, <code>FROM kubernetes-rawdocker:v1.19.8</code> should be the first line in your Kubefile.</p>
<h3 id="How-to-build-raw-docker-BaseImage"><a href="#How-to-build-raw-docker-BaseImage" class="headerlink" title="How to build raw docker BaseImage"></a>How to build raw docker BaseImage</h3><h4 id="Step-1：choose-a-base-image"><a href="#Step-1：choose-a-base-image" class="headerlink" title="Step 1：choose a base image"></a>Step 1：choose a base image</h4><p>Get an image which you will modify it later, you may think it as your base image. To demonstrate the workflow, I will use <code>kubernetes:v1.19.8</code>. You can get the same image by executing <code>sealer pull kubernetes:v1.19.8</code>.</p>
<h4 id="Step-2-find-the-layers-you-will-use-later"><a href="#Step-2-find-the-layers-you-will-use-later" class="headerlink" title="Step 2: find the layers you will use later"></a>Step 2: find the layers you will use later</h4><p>Find the image layer id by executing <code>sealer inspect kubernetes:v1.19.8</code>. There are four layers in this image, and you will only use two of them. The first one’s id is <code>c1aa4aff818df1dd51bd4d28decda5fe695bea8a9ae6f63a8dd5541c7640b3d6</code>, it consist of bin files, config files, registry files, scripts and so on. (I will use {layer-id-1} to refer to it in the following. Actually, it’s a sha256 string) The another one’s id is <code>991491d3025bd1086754230eee1a04b328b3d737424f1e12f708d651e6d66860</code>, it consist of network component yaml files. (I will use {layer-id-2} to refer to it in the following. Actually, it’s also a sha256 string)</p>
<h4 id="Step-3-get-official-raw-docker"><a href="#Step-3-get-official-raw-docker" class="headerlink" title="Step 3: get official raw docker"></a>Step 3: get official raw docker</h4><p>Choose a raw docker binary version from <code>https://download.docker.com/linux/static/stable/x86_64/</code> if your machine is based on x86_64 architecture, and download it. (other architecture can be found at <code>https://download.docker.com/linux/static/stable/</code>)</p>
<h4 id="Step-4-replace-sealer-hacked-docker"><a href="#Step-4-replace-sealer-hacked-docker" class="headerlink" title="Step 4: replace sealer hacked docker"></a>Step 4: replace sealer hacked docker</h4><p>Replace <code>/var/lib/sealer/data/overlay2/&#123;layer-id-1&#125;/cri/docker.tar.gz</code> with the file you download in step 3, Before replacement you should do some handles.  <strong>Attention</strong> that you should make sure after replacement the compressed file name and untarred working directory tree is same as before. In this case, you should untar the file you download in step 3, enter the <code>docker</code> directory and tar all files in this directory with an output file whose name is <code>docker.tar.gz</code>.</p>
<h4 id="Step-5-replace-sealer-hacked-registry"><a href="#Step-5-replace-sealer-hacked-registry" class="headerlink" title="Step 5: replace sealer hacked registry"></a>Step 5: replace sealer hacked registry</h4><p>Pull the official “registry” image and replace existing customized “registry” image at <code>/var/lib/sealer/data/overlay2/&#123;layer-id-1&#125;/images/registry.tar</code>. Firstly make sure raw docker have already installed, then execute <code>docker pull registry:2.7.1 &amp;&amp; docker save -o registry.tar registry:2.7.1 &amp;&amp; mv registry.tar /var/lib/sealer/data/overlay2/&#123;layer-id-1&#125;/images/registry.tar</code>.</p>
<h4 id="Step-6-modify-daemon-json"><a href="#Step-6-modify-daemon-json" class="headerlink" title="Step 6: modify daemon.json"></a>Step 6: modify daemon.json</h4><p>Edit the file ‘daemon.json’ at <code>/var/lib/sealer/data/overlay2/&#123;layer-id-1&#125;/etc/</code>, delete the <code>mirror-registries</code> attribute.</p>
<h4 id="Step-7-build-rawdocker-alpine-image"><a href="#Step-7-build-rawdocker-alpine-image" class="headerlink" title="Step 7: build rawdocker alpine image"></a>Step 7: build rawdocker alpine image</h4><p>Switch to directory <code>/var/lib/sealer/data/overlay2/&#123;layer-id-1&#125;/</code>, edit the <code>Kubefile</code> and make sure it’s content is:</p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">FROM scratch</span><br><span class="line">COPY . .</span><br></pre></td></tr></table></figure>

<p>Then build image by execute <code>sealer build --mode lite -t kubernetes-rawdocker:v1.19.8-alpine .</code>.</p>
<h4 id="Extension"><a href="#Extension" class="headerlink" title="Extension"></a>Extension</h4><h4 id="Step-8-add-network-components-to-alpine-image"><a href="#Step-8-add-network-components-to-alpine-image" class="headerlink" title="Step 8: add network components to alpine image"></a>Step 8: add network components to alpine image</h4><p>Now the base image still need network components to make k8s clusters work well, here we provide a guide for adding calico as network components.<br>First of all, create a <code>rawdockerBuild</code> directory as your build environment. Then you should move the file “tigera-operator.yaml” and the file “custom-resources.yaml” from <code>/var/lib/sealer/data/overlay2/&#123;layer-id-2&#125;/etc/</code> to <code>rawdockerBuild/etc</code>. After that you still need modify some contents in those two files to make sure the pods they create will pull docker images from your private registry, which will make your k8s clusters still work well in offline situations. In this case, firstly add a map-key value in “custom-resources.yaml”, the key is <code>spec.registry</code> and the value is <code>sea.hub:5000</code>, secondly modify all docker image names in “tigera-operator.yaml” from <code>&lt;registry&gt;/&lt;repository&gt;/&lt;imageName&gt;:&lt;imageTag&gt;</code> to <code>sea.hub:5000/&lt;repository&gt;/&lt;imageName&gt;:&lt;imageTag&gt;</code>.<br>Next create a <code>imageList</code> file at <code>rawdockerBuild</code> directory, with the following content:</p>
<ul>
<li>calico&#x2F;cni:v3.19.1</li>
<li>calico&#x2F;kube-controllers:v3.19.1</li>
<li>calico&#x2F;node:v3.19.1</li>
<li>calico&#x2F;pod2daemon-flexvol:v3.19.1</li>
<li>calico&#x2F;typha:v3.19.1</li>
<li>tigrea&#x2F;operator:v1.17.4</li>
</ul>
<p>They are all the images needed to create network components, make sure that the tag is consistent with declared in the yaml file “tigera-operator.yaml” and “custom-resources.yaml”.</p>
<h4 id="Step-9-build-rawdocker-image"><a href="#Step-9-build-rawdocker-image" class="headerlink" title="Step 9: build rawdocker image"></a>Step 9: build rawdocker image</h4><p>Switch to directory <code>rawdockerBuild</code>, create a <code>Kubefile</code> and make sure it’s content is:</p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">FROM kubernetes-rawdocker:v1.19.8-alpine</span><br><span class="line">COPY imageList manifests</span><br><span class="line">COPY etc .</span><br><span class="line">CMD kubectl apply -f etc/tigera-operator.yaml &amp;&amp; kubectl apply -f etc/custom-resources.yaml</span><br></pre></td></tr></table></figure>

<p>Then build image by execute <code>sealer build --mode lite -t kubernetes-rawdocker:v1.19.8 .</code>.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/02/15/zh/advanced/raw-docker-baseimage/" data-id="cl1fryzy4000a26e2dy482r6j" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-zh/advanced/gpu-cloudimage" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/02/15/zh/advanced/gpu-cloudimage/" class="article-date">
  <time class="dt-published" datetime="2022-02-15T02:17:58.619Z" itemprop="datePublished">2022-02-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="GPU-CloudImage"><a href="#GPU-CloudImage" class="headerlink" title="GPU CloudImage"></a>GPU CloudImage</h1><h2 id="Preparation"><a href="#Preparation" class="headerlink" title="Preparation"></a>Preparation</h2><ol>
<li>Install nvidia driver on your host.</li>
<li>Install the latest version of sealer on your host.</li>
</ol>
<h2 id="How-to-build-it"><a href="#How-to-build-it" class="headerlink" title="How to build it"></a>How to build it</h2><p>We provide GPU base image in our official registry<br>named <code>registry.cn-qingdao.aliyuncs.com/sealer-io/kubernetes-nvidia:v1.19.8</code>.you can use is directly. meanwhile, we<br>provide the build context in the applications’ directory. it can be adjusted it per your request.</p>
<p>Run below command to rebuild it.</p>
<p><code>sealer build -f Kubefile -t registry.cn-qingdao.aliyuncs.com/sealer-io/kubernetes-nvidia:v1.19.8 -m lite .</code></p>
<h2 id="How-to-apply-it"><a href="#How-to-apply-it" class="headerlink" title="How to apply it"></a>How to apply it</h2><ol>
<li>Modify the Clusterfile according to your infra environment,here is the Clusterfile for example.</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">sealer.cloud/v2</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Cluster</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">default-kubernetes-cluster</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">registry.cn-qingdao.aliyuncs.com/sealer-io/kubernetes-nvidia:v1.19.8</span></span><br><span class="line">  <span class="attr">ssh:</span></span><br><span class="line">    <span class="attr">passwd:</span> <span class="string">xxx</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">ips:</span> [ <span class="number">192.168</span><span class="number">.0</span><span class="number">.2</span>,<span class="number">192.168</span><span class="number">.0</span><span class="number">.3</span>,<span class="number">192.168</span><span class="number">.0</span><span class="number">.4</span> ]</span><br><span class="line">      <span class="attr">roles:</span> [ <span class="string">master</span> ]</span><br><span class="line">    <span class="bullet">-</span> <span class="attr">ips:</span> [ <span class="number">192.168</span><span class="number">.0</span><span class="number">.5</span> ]</span><br><span class="line">      <span class="attr">roles:</span> [ <span class="string">node</span> ]</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>Run command <code>sealer apply -f Clusterfile</code> to apply the GPU cluster. it will take few minutes.</li>
</ol>
<h2 id="How-to-check-the-result"><a href="#How-to-check-the-result" class="headerlink" title="How to check the result"></a>How to check the result</h2><ol>
<li>Check the pod status to run <code>kubectl get pods -n kube-system nvidia-device-plugin</code>, you can find the pod in Running<br>status.</li>
<li>Get the node details to run <code>kubectl describe node</code>, if <code>nvidia.com/gpu</code> shows on ‘Allocated resources’ section,you<br>get a k8s cluster with GPU.</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/02/15/zh/advanced/gpu-cloudimage/" data-id="cl1fryzy6000b26e26ema4wb4" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/3/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">April 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/03/">March 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/02/">February 2022</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2022/04/01/blog/">blog</a>
          </li>
        
          <li>
            <a href="/2022/03/31/hello-world/">Hello World</a>
          </li>
        
          <li>
            <a href="/2022/03/29/zh/getting-started/plugin/">(no title)</a>
          </li>
        
          <li>
            <a href="/2022/03/23/zh/getting-started/quick-start/">(no title)</a>
          </li>
        
          <li>
            <a href="/2022/03/18/zh/getting-started/introduction/">(no title)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2022 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>